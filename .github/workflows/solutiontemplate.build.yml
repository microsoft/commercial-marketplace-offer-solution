# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.
name: SolutionTemplateBuild
on:
  workflow_dispatch:
  pull_request:
jobs:
  ValidateARMTemplates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Generate ARM template from Bicep templates
        uses: Azure/bicep-build-action@v1.0.1
        with:
          bicepFilePath: ./samples/solution-template/base-image-vm/app-contents/mainTemplate.bicep
          outputFilePath: ./samples/solution-template/base-image-vm/app-contents/mainTemplate.json
      - name: Run ARM-TTK
        uses: ./.github/actions/run-armttk
        with:
          templatesFolderPath: ./samples/solution-template/base-image-vm/app-contents
          armttkVersion: aka.ms/arm-ttk-latest
  BuildDraftOffer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Generate config files
        uses: ./.github/actions/generateCLIConfig
        with:
          configYamlPath: ${GITHUB_WORKSPACE}/samples/solution-template/base-image-vm/config.yml
          AAD_TENANTID: ${{ secrets.AAD_TENANTID }}
          AAD_CLIENTID: ${{ secrets.AAD_CLIENTID }}
          AAD_CLIENTSECRET: ${{ secrets.AAD_CLIENTSECRET }}
          PARNERCENTER_MANAGEDAPPPRINCIPALID: ${{ secrets.PARNERCENTER_MANAGEDAPPPRINCIPALID }}
          PARNERCENTER_PUBLISHERID: ${{ secrets.PARNERCENTER_PUBLISHERID }}
          AZURE_SUBSCRIPTIONID: ${{ secrets.AZURE_SUBSCRIPTIONID }}'
          AZURE_LOCATION: ${{ secrets.AZURE_LOCATION }}
          AZURE_ADMINPASSWORD: ${{ secrets.AZURE_ADMINPASSWORD }}
          AZURE_STORAGEACCOUNTRESOURCEGROUP: ${{ secrets.AZURE_STORAGEACCOUNTRESOURCEGROUP }}
          AZURE_STORAGEACCOUNTNAME: ${{ secrets.AZURE_STORAGEACCOUNTNAME }}
          AZURE_STORAGEACCOUNTKEY: ${{ secrets.AZURE_STORAGEACCOUNTKEY }}
      - name: Install dependencies
        uses: ./.github/actions/installDependencies
      - name: Install Partner Center CLI
        uses: ./.github/actions/installPartnerCenterCLI

